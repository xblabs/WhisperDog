# Checkpoint: CP_2026_01_24_005 - Opus Code Audit
**Date**: 2026-01-24 23:25
**Type**: save_point
**Resumed From**: CP_2026_01_24_004
**Status**: Audit complete, 17 issues identified across 4 severity levels

---

## Summary
Comprehensive Opus 4.5 audit of Haiku-authored system audio capture code. All implementation is functionally complete (Clusters 1-5 done), but code quality issues found ranging from a critical operator precedence bug to cosmetic concerns. Commit `7059e0c` contains all current code.

---

## Audit Findings (17 Issues)

### CRITICAL BUGS (Fix Now)

#### 1. Operator Precedence Bug - SourceActivityTracker.java:224
- **Impact**: 8-bit WAV RMS calculations produce wrong values, breaking activity detection
- **Current**: `(bb.get() & 0xFF - 128) / 128.0`
- **Evaluates as**: `bb.get() & (0xFF - 128)` = `bb.get() & 127` (bitwise AND mask)
- **Fix**: `((bb.get() & 0xFF) - 128) / 128.0`
- **Risk**: Silent data corruption for 8-bit audio files

#### 2. Python Format String - AudioCaptureManager.java:162
- **Impact**: Log message shows literal `{:.1f}s` instead of formatted duration
- **Current**: `logger.info("System audio saved: {} bytes, {:.1f}s", ...)`
- **Fix**: Use `{}` with `String.format("%.1f", value)` or pre-format the argument
- **Risk**: Low (cosmetic log issue, non-fatal)

#### 3. FFmpegUtil.mergeAudioTracks Potential Hang - Lines 340-347
- **Impact**: If ffmpeg hangs without closing stdout, the reader loop blocks forever
- **Problem**: `reader.readLine()` blocks before `process.waitFor(120, SECONDS)` is reached
- **Fix**: Read output in a separate daemon thread, or redirect to file and use `waitFor` directly
- **Risk**: App hangs indefinitely if ffmpeg encounters an edge case

---

### HIGH SEVERITY (Should Fix)

#### 4. Thread-unsafe Diagnostic Counters - SystemAudioCapture.java:313-315
- **Fields**: `totalBufferCalls`, `nonSilentBuffers`, `peakSample`
- **Problem**: Written from native audio callback, read from main thread, no synchronization
- **Fix**: Use `AtomicLong` / `volatile float` or `LongAdder`

#### 5. LOOPBACK_GAIN = 8.0f Too Aggressive - SystemAudioCapture.java:25
- **Impact**: Any system audio sample > 0.125 abs clips to +-1.0 (severe distortion)
- **Problem**: Normal system audio peaks 0.5-1.0, so 80%+ of signal clips
- **Fix**: Reduce to 2.0-3.0, or implement post-capture normalization
- **Risk**: Distorted/clipped system audio in all recordings

#### 6. isAvailable() Called on EDT - RecorderForm.java:271
- **Impact**: Native WASAPI enumeration blocks UI thread during startup
- **Problem**: `SystemAudioCapture.isAvailable()` creates XtPlatform + enumerates devices
- **Fix**: Cache result, or check asynchronously with SwingWorker
- **Risk**: UI lag on startup (noticeable on slow audio drivers)

#### 7. ByteBuffer Underflow Risk - SourceActivityTracker.calculateRms():213-228
- **Impact**: BufferUnderflowException if bytesRead not evenly divisible by frame size
- **Problem**: Loop reads `samplesRead` frames but doesn't account for partial trailing frames
- **Fix**: `int samplesRead = bytesRead / (bytesPerSample * channels);` then limit ByteBuffer reads

#### 8. Mid-Recording Toggle Timeline Misalignment - AudioCaptureManager:194-229
- **Impact**: Source attribution produces incorrect labels when toggled mid-recording
- **Problem**: New SystemAudioCapture starts at t=0 but mic is already N seconds in
- **Fix**: Record toggle timestamp and offset system track in SourceActivityTracker
- **Note**: UI already disables toggle during recording (bug #19 from previous session), but programmatic path still allows it

---

### MEDIUM SEVERITY (Worth Fixing)

#### 9. onBuffer Unsafe Array Access - SystemAudioCapture.java:338+345
- **Problem**: `convertFloatToInt16` uses `frames` without checking `samples.length >= frames * deviceChannels`
- **Fix**: Add bounds check before conversion

#### 10. capturedAudio Race Window - SystemAudioCapture.java:450-494
- **Problem**: After `capturing.set(false)`, callback may still be writing; `toByteArray()` could read partial data
- **Fix**: Add a brief drain delay or acquire lock before cleanup

#### 11. Emergency System.err Logging - RecorderForm.java:1769-1772
- **Problem**: Debug scaffolding left in production: `System.err.println("[EMERGENCY]...")`
- **Fix**: Convert to `logger.debug()` or remove

#### 12. Temp File Accumulation - FFmpegUtil & AudioCaptureManager
- **Problem**: `deleteOnExit()` only cleans on JVM shutdown; long-running app accumulates files
- **Fix**: Explicit cleanup in transcription worker's `done()` method

---

### LOW SEVERITY (Cosmetic / Future)

#### 13. Nearest-Neighbor Resampling Aliasing - SystemAudioCapture.java:388
- Known limitation. Linear interpolation would be minimal improvement.

#### 14. Unnecessary log4j-api Exclusion - pom.xml:103-108
- Both at 2.23.1, exclusion is redundant.

#### 15. Mixed httpclient Versions - pom.xml:125 vs 132
- 4.5.13 vs 4.5.14 mismatch. Trivial.

#### 16. listLoopbackDevices() Platform Race - SystemAudioCapture.java:83
- `volatile` provides visibility but not atomicity of create-and-assign.

#### 17. Test Class in src/main/java - SourceActivityTrackerTest.java
- Manual test harness packaged into production JAR. Move to src/test/java.

---

## Recommended Fix Order

1. **#1** - Operator precedence (1 line, critical correctness)
2. **#5** - Loopback gain (1 line, audio quality)
3. **#2** - Format string (1 line, log correctness)
4. **#3** - FFmpeg hang prevention (restructure output reading)
5. **#7** - ByteBuffer underflow guard
6. **#11** - Remove emergency logging
7. **#4** - Thread-safe counters
8. **#12** - Temp file cleanup
9. **#6** - EDT blocking (async isAvailable)
10. **#9** - onBuffer bounds check

---

## Files Involved

| File | Issues |
|------|--------|
| SourceActivityTracker.java | #1, #7 |
| SystemAudioCapture.java | #4, #5, #9, #10, #16 |
| AudioCaptureManager.java | #2, #8, #12 |
| FFmpegUtil.java | #3, #12 |
| RecorderForm.java | #6, #11 |
| pom.xml | #14, #15 |
| SourceActivityTrackerTest.java | #17 |

---

## Task Checklist Status
- Clusters 1-5: COMPLETE
- Cluster 6 (Testing): NOT STARTED (requires manual GUI testing)
- Code audit: COMPLETE (this checkpoint)

---

## Build State
- Last commit: `7059e0c` (feat(TASK-0006): complete system audio capture)
- Build: Clean (`mvn package` succeeds)
- JAR: `target/whisperdog-2.0.0-jar-with-dependencies.jar`

---

**Checkpoint Created**: 2026-01-24T23:25:00Z
**Status**: Ready for bug fixes based on audit findings
