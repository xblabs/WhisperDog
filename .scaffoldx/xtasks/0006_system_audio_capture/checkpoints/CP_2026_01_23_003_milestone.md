---
# === CHECKPOINT IDENTITY ===
checkpoint_id: CP_2026_01_23_003
checkpoint_type: milestone
created: 2026-01-23T15:59:23.857Z
format_version: "1.0"

# === ENTITY CONTEXT ===
entity_type: task
entity_id: "0006"
entity_name: "Clusters 4-5 Complete: UI + Pipeline Integration"

# === TRIGGER METADATA ===
trigger: manual
trigger_source: null
trigger_reason: null

# === SESSION CONTEXT ===
user: "User"
environment: "unknown"

# === CONSUMPTION METADATA ===
priority: high
auto_load: true
expires_after: null
replaces: []

---

# Milestone: Clusters 4-5 Complete — UI Integration + Pipeline Integration

**Type**: milestone
**Created**: 2026-01-23
**Task**: 0006 - System Audio Capture
**Priority**: high
**AutoLoad**: true

---

## Progress Summary

### Completed
- **Cluster 1**: Platform Research & Feasibility (6/6)
- **Cluster 2**: Dual-Track Capture Infrastructure (7/7)
- **Cluster 3**: Source Attribution Logic (7/7)
- **Cluster 4**: UI Integration (6/6) ✅ THIS SESSION
- **Cluster 5**: Pipeline Integration (5/5) ✅ THIS SESSION

### Remaining
- **Cluster 6**: Testing & Verification (0/7) — NEXT

---

## Cluster 4 Implementation Details

### System Audio Toggle (RecorderForm)
- JCheckBox "System Audio" added to `statusIndicatorPanel` (next to record button)
- Only visible when `SystemAudioCapture.isAvailable()` returns true
- Persists state via `configManager.isSystemAudioEnabled()`

### Visual Indicator
- `systemAudioIndicator`: 16x16 JPanel with custom paintComponent
- Colors: teal (idle, system audio enabled), deep sky blue (recording active)
- Visibility tied to toggle state

### On-the-Fly Toggle During Recording
- Toggle remains enabled during recording
- Action listener calls `audioCaptureManager.toggleSystemAudio(enabled)` when recording is active
- Reverts toggle if operation fails

### Settings Panel (SettingsForm)
- "System audio capture:" with "Enable by default" checkbox
- "Loopback device:" dropdown populated from `SystemAudioCapture.listLoopbackDevices()`
- Device preference saved via `configManager.getSystemAudioDevice()` / `setSystemAudioDevice()`

### ConfigManager Additions
- `isSystemAudioEnabled()` / `setSystemAudioEnabled(boolean)` — default: false
- `getSystemAudioDevice()` / `setSystemAudioDevice(String)` — default: ""

---

## Cluster 5 Implementation Details

### Merge Strategy Decision
- **Pre-transcription merge**: Mix mic + system tracks via ffmpeg, transcribe once
- **Post-transcription labeling**: Analyze original separate tracks for source attribution
- Rationale: Single transcription call, simpler pipeline, better accuracy

### Track Merging (FFmpegUtil.mergeAudioTracks)
- Added to `src/main/java/org/whisperdog/audio/FFmpegUtil.java`
- Command: `ffmpeg -y -i mic.wav -i sys.wav -filter_complex "[0:a][1:a]amix=inputs=2:duration=longest:normalize=0" -acodec pcm_s16le -ar 16000 -ac 1 output.wav`
- `normalize=0`: Preserves original levels (no auto-normalization)
- Returns null on failure (graceful fallback to mic-only)

### Silence Removal Interaction
- **Dual-source recordings**: Silence removal SKIPPED (breaks timeline alignment)
- **Mic-only recordings**: Silence removal applied as before
- Decision point in AudioTranscriptionWorker.doInBackground()

### Source Attribution Pipeline
In AudioTranscriptionWorker.doInBackground(), after transcription:
1. `SourceActivityTracker tracker = new SourceActivityTracker()`
2. `tracker.trackActivity(micFile, systemTrackFile)` → activity timeline
3. `tracker.labelTranscript(result, timeline)` → labeled transcript
4. Labeled text flows to transcriptionTextArea, history panel, clipboard

### Recording Flow (RecorderForm)
- `startRecording()`: When system audio enabled, creates `AudioCaptureManager`, sets preferred device, calls `startCapture(true)`
- `stopRecording()`: Calls `audioCaptureManager.stopCapture()`, gets both `micFile` and `systemTrackFile`, passes both to `AudioTranscriptionWorker(micFile, sysFile)`
- When system audio disabled: existing `AudioRecorder` path unchanged

---

## Files Modified This Session

### Core Changes
- `src/main/java/org/whisperdog/recording/RecorderForm.java`:
  - Added imports: SystemAudioCapture, AudioCaptureManager, SourceActivityTracker
  - Added fields: systemAudioToggle, systemAudioIndicator, audioCaptureManager
  - Modified: startRecording(), stopRecording(), updateUIForRecordingStart()
  - Modified: AudioTranscriptionWorker (added systemTrackFile, merge, labeling)

- `src/main/java/org/whisperdog/ConfigManager.java`:
  - Added: isSystemAudioEnabled(), setSystemAudioEnabled()
  - Added: getSystemAudioDevice(), setSystemAudioDevice()

- `src/main/java/org/whisperdog/settings/SettingsForm.java`:
  - Added import: SystemAudioCapture
  - Added: System Audio section (default toggle + device dropdown)

- `src/main/java/org/whisperdog/audio/FFmpegUtil.java`:
  - Added: mergeAudioTracks(File, File) method

### Unchanged (from prior sessions)
- `src/main/java/org/whisperdog/audio/SystemAudioCapture.java` (Cluster 2)
- `src/main/java/org/whisperdog/audio/AudioCaptureManager.java` (Cluster 2)
- `src/main/java/org/whisperdog/audio/SourceActivityTracker.java` (Cluster 3)

---

## Cluster 6: Testing Checklist (NEXT)

- [ ] Test with YouTube video + commentary
- [ ] Test with voice message playback + response
- [ ] Test toggle during active recording
- [ ] Test long recording (30+ min)
- [ ] Test when system audio unavailable (graceful fallback)
- [ ] Verify temp files cleaned up properly
- [ ] Test in both light and dark themes

### Notes for Testing
- Graceful fallback: `SystemAudioCapture.isAvailable()` gate + null checks throughout
- Temp cleanup: `AudioCaptureManager.cleanupTempFiles()` + `deleteOnExit()` on merged file
- Theme test: systemAudioIndicator uses custom paint (no LAF dependency)
- Available loopback devices (user's system):
  - [0] Headset Earphone (Plantronics Blackwire 3210 Series) (Loopback)
  - [1] Realtek Digital Output (Realtek High Definition Audio) (Loopback)
  - [2] Speakers (Sound Blaster Play! 3) (Loopback)

### Test Command
```powershell
powershell -ExecutionPolicy Bypass -File .\run-test.ps1 org.whisperdog.audio.SourceActivityTrackerTest
```

---

## Architecture Decisions

1. **AudioCaptureManager as optional wrapper**: Only used when system audio is enabled. Mic-only path uses direct AudioRecorder (zero-regression risk).
2. **FFmpeg for merge**: Already a dependency for video extraction. amix filter handles different track lengths gracefully.
3. **Silence removal skip**: Deliberate trade-off — source attribution accuracy > silence removal for dual-source recordings.
4. **On-the-fly toggle**: Delegates to AudioCaptureManager.toggleSystemAudio() which handles init/dispose lifecycle.