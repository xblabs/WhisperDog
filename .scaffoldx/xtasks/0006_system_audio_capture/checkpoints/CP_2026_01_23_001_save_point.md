# Checkpoint: CP_2026_01_23_001

**Type**: save_point
**Created**: 2026-01-23T02:15:00Z
**Task**: 0006 - System Audio Capture
**Priority**: high
**AutoLoad**: true

---

## Progress Summary

### Completed
- **Cluster 1**: Platform Research & Feasibility (6/6) ✅
- **Cluster 2**: Dual-Track Capture Infrastructure (7/7) ✅
- **Cluster 3**: Source Attribution Logic (6/7) ✅ (test pending)

### Current Position
- **Cluster 3, Item 7**: Test labeling accuracy - IN PROGRESS
- System audio capture WORKS but needs gain tuning

### Key Findings This Session
1. **Wrong device bug found & fixed**: `initialize()` grabbed first loopback device (Plantronics headset) instead of active output (Sound Blaster speakers)
2. **Device selection added**: `initialize(String preferredDevice)` with partial name matching
3. **Auto-detect added**: `getDefaultOutputDeviceName()` queries WASAPI OUTPUT device list
4. **Low volume issue**: Raw loopback peak = 0.081. Added `LOOPBACK_GAIN = 4.0f` - audible but could be louder (try 8.0f next)
5. **Diagnostics added**: `getDiagnostics()` shows buffer stats, non-silent count, peak value

### Diagnostic Results (Last Run)
```
Device: Speakers (Sound Blaster Play! 3) (Loopback)
Format: 48000Hz, 2 channels, FLOAT32
Buffers: 1006 total, 560 non-silent (55.7%), peak: 0.081440
Captured: 312,960 bytes (9.78s)
```

### Files Created This Session
- `src/main/java/org/whisperdog/audio/AudioCaptureManager.java` - Dual-source coordinator
- `src/main/java/org/whisperdog/audio/SourceActivityTracker.java` - RMS activity detection + transcript labeling
- `src/main/java/org/whisperdog/audio/SourceActivityTrackerTest.java` - Interactive test
- `run-test.ps1` - PowerShell test runner (works with classpath)
- `run-test.bat` - CMD test runner (argfile approach)

### Files Modified This Session
- `src/main/java/org/whisperdog/audio/SystemAudioCapture.java`:
  - Added `initialize(String preferredDevice)` overload
  - Added `getDefaultOutputDeviceName()` auto-detection
  - Added `LOOPBACK_GAIN = 4.0f` amplification
  - Added diagnostic counters (totalBufferCalls, nonSilentBuffers, peakSample)
  - Added `getDiagnostics()` method

### Next Steps (Priority Order)
1. **Tune gain**: Try `LOOPBACK_GAIN = 8.0f` or implement dynamic normalization
2. **Run SourceActivityTrackerTest**: Verify RMS detection with real dual-track audio
3. **Cluster 4: UI Integration**: Add loopback device dropdown in Settings
4. **Cluster 5: Pipeline Integration**: Wire AudioCaptureManager into RecorderForm

### Available Loopback Devices (User's System)
- [0] Headset Earphone (Plantronics Blackwire 3210 Series) (Loopback)
- [1] Realtek Digital Output (Realtek High Definition Audio) (Loopback)
- [2] Speakers (Sound Blaster Play! 3) (Loopback)

### Test Command
```powershell
powershell -ExecutionPolicy Bypass -File .\run-test.ps1 org.whisperdog.audio.SystemAudioCapture "Sound Blaster"
```

### Last Commit
- 49bc590 feat(TASK-0006): add system audio capture with WASAPI loopback
