---
# === CHECKPOINT IDENTITY ===
checkpoint_id: CP_2026_01_24_001
checkpoint_type: save_point
created: 2026-01-24T05:00:00.000Z
format_version: "1.0"

# === ENTITY CONTEXT ===
entity_type: task
entity_id: "0006"
entity_name: "Cluster 6 Testing - Bugs Found & Fixed, Attribution Unresolved"

# === TRIGGER METADATA ===
trigger: manual
trigger_source: null
trigger_reason: "Session handover - system audio capture partially working, attribution broken"

# === SESSION CONTEXT ===
user: "Henry"
environment: "claude-code"

# === CONSUMPTION METADATA ===
priority: high
auto_load: true
expires_after: null
replaces: []

---

# Save Point: Cluster 6 Testing — Bugs Found & Partially Fixed

**Type**: save_point
**Created**: 2026-01-24
**Task**: 0006 - System Audio Capture
**Priority**: high
**AutoLoad**: true

---

## Session Summary

Started Cluster 6 (Testing & Verification). Found and fixed multiple bugs during live testing. System audio capture is partially working (captures + merges + transcribes), but device auto-detection is broken and source attribution is inaccurate.

---

## Bugs Fixed This Session

### 1. FFmpeg `normalize=0` Incompatibility
- **Root cause**: User had ffmpeg 4.2.3 which doesn't support `normalize` option on `amix` filter (added in 4.4+)
- **Fix**: Kept `normalize=0` (important for preserving levels), user upgraded to ffmpeg 8.0.1
- **File**: `src/main/java/org/whisperdog/audio/FFmpegUtil.java:328`
- **Note**: Error message now includes "requires ffmpeg 4.4+" for clarity

### 2. Temp File Leak
- **Root cause**: `micTrackFile` and `systemTrackFile` in AudioCaptureManager had no `deleteOnExit()` — persisted after JVM exit
- **Fix**: Added `deleteOnExit()` at all 3 creation points (startCapture mic, startCapture system, toggleSystemAudio system)
- **File**: `src/main/java/org/whisperdog/audio/AudioCaptureManager.java:82,96,210`

### 3. Device Auto-Detection Uses Wrong Device
- **Root cause**: `getDefaultOutputDeviceName()` in SystemAudioCapture just takes `getId(0)` from WASAPI output list — NOT the active output device
- **Symptom**: On user's system, first device is Plantronics (headset), but audio plays through Sound Blaster (USB DAC)
- **Partial fix**: AudioCaptureManager now calls `initialize()` (auto-detect) when no device configured, instead of `initialize(null)` (first device). But auto-detect itself is still broken.
- **Workaround**: User must explicitly select device in Settings > Loopback device dropdown
- **STILL BROKEN**: `getDefaultOutputDeviceName()` needs to actually query the Windows default audio endpoint, not just take index 0

### 4. Start Order Conflict (Investigatory)
- **Hypothesis**: Starting mic recording (Java Sound API) before system audio (XT-Audio WASAPI) might cause WASAPI contention
- **Fix**: Reversed start order — system audio starts first, then mic thread
- **Status**: Not confirmed as root cause, but logically sound to establish WASAPI stream first
- **File**: `src/main/java/org/whisperdog/audio/AudioCaptureManager.java:109-128`

### 5. `labelTranscript()` Was a Stub
- **Root cause**: The method just used the first non-silence segment's source for ALL text — everything labeled `[User]`
- **Fix**: Rewrote to distribute words proportionally across timeline based on estimated timestamps
- **Limitation**: Without word-level timestamps from Whisper, proportional distribution is approximate
- **File**: `src/main/java/org/whisperdog/audio/SourceActivityTracker.java:278-334`

### 6. Diagnostics Logging Added
- Added `systemCapture.getDiagnostics()` call before stop in AudioCaptureManager
- Shows: device name, total buffers, non-silent buffer %, peak sample value
- **File**: `src/main/java/org/whisperdog/audio/AudioCaptureManager.java:153`

---

## Current State: What Works

1. **System audio toggle UI**: Visible when WASAPI available, persists state, on-the-fly toggle
2. **WASAPI loopback capture**: Works when correct device is selected (PoC confirmed Sound Blaster at peak 0.041152)
3. **FFmpeg merge**: Works with ffmpeg 8.0.1, `normalize=0` preserves levels
4. **Dual-source transcription**: Merged audio sent to Whisper, both sources transcribed correctly
5. **Graceful fallbacks**: All 9 fallback layers verified (UI gate, init failure, merge failure, etc.)
6. **Temp file cleanup**: `deleteOnExit()` on all temp files + `cleanupTempFiles()` on cancellation

---

## Current State: What's Broken

### Issue A: Device Auto-Detection (HIGH PRIORITY)
- `getDefaultOutputDeviceName()` picks first WASAPI output device, not the active one
- User's system: first device = Plantronics, active device = Sound Blaster
- **Result**: Captures silence when "(Default)" is selected in Settings
- **User workaround**: Route audio through Plantronics OR explicitly select Sound Blaster in Settings
- **Proper fix needed**: Query Windows audio endpoint API for actual default device
- **Untested**: Whether explicit Sound Blaster selection in Settings works in-app (user tested with auto-detect)

### Issue B: Source Attribution Accuracy (HIGH PRIORITY)
- Proportional word distribution is a rough heuristic
- Mic picks up headphone bleed, so both tracks show activity during system audio
- Timeline segments may not align well with actual speech boundaries
- **Proper fix**: Use Whisper's word-level timestamps (`timestamp_granularities: ["word"]`) and `labelTranscriptWithTimestamps()` method (already exists in code)
- **Alternative**: Increase RMS threshold or add better filtering to distinguish bleed from direct audio

### Issue C: Log Format String Bug (LOW)
- `AudioCaptureManager.java:157`: `{:.1f}` is Python format, not SLF4J
- SLF4J just uses `{}` and toString() — the float division result will print with full precision
- Fix: Use `String.format("%.1f", ...)` inside the logger call, or just let it print

---

## User's Hardware Context

- **Mic**: Connected via separate device (likely Plantronics or onboard)
- **Audio output**: Sound Blaster Play! 3 (USB DAC) → Headphones
- **Available loopback devices**:
  - `[0]` Headset Earphone (Plantronics Blackwire 3210 Series) (Loopback)
  - `[1]` Realtek Digital Output (Realtek High Definition Audio) (Loopback)
  - `[2]` Speakers (Sound Blaster Play! 3) (Loopback)
- **Sound Blaster PoC results**: 48000Hz, 2ch, FLOAT32 format. Peak 0.041152 raw (0.33 after 8x gain). Output WAV: -26.6 dB mean, -10.1 dB max.
- **ffmpeg version**: 8.0.1 (upgraded from 4.2.3 this session)

---

## Files Modified This Session

- `src/main/java/org/whisperdog/audio/FFmpegUtil.java` — normalize=0 fix, doMerge refactor reverted to simple version
- `src/main/java/org/whisperdog/audio/AudioCaptureManager.java` — deleteOnExit, auto-detect path, start order, diagnostics
- `src/main/java/org/whisperdog/audio/SourceActivityTracker.java` — labelTranscript() rewritten

---

## Next Steps (Priority Order)

1. **Fix device auto-detection** — Use proper Windows API to get default audio endpoint (not just WASAPI enumerate index 0). Could use `IMMDeviceEnumerator::GetDefaultAudioEndpoint` via JNA, or match against Windows "Default Device" marker in xt-audio.

2. **Confirm Sound Blaster works in-app** — User needs to explicitly select "Speakers (Sound Blaster Play! 3) (Loopback)" in Settings and verify the log shows "Matched preferred loopback device" with non-silent buffers. This confirms whether the issue is purely auto-detect or also a concurrent-capture conflict.

3. **Fix source attribution** — Either:
   - (A) Request word-level timestamps from OpenAI API and use existing `labelTranscriptWithTimestamps()` method
   - (B) Improve RMS-based detection: increase threshold, add low-pass filtering, or use spectral analysis to distinguish headphone bleed from direct mic input
   - (C) Accept the proportional approach as "good enough" for V1

4. **Update Cluster 6 checklist** — Mark items tested, add new items for found bugs

---

## Test Results Summary

| Test | Result | Notes |
|------|--------|-------|
| Compilation | PASS | Clean build with all changes |
| Mic-only recording | PASS | No regression, existing path unchanged |
| System audio toggle visibility | PASS | Only shown when WASAPI available |
| FFmpeg merge | PASS | Works with ffmpeg 8.0.1 + normalize=0 |
| Dual-source transcription | PASS | Both sources in merged audio, Whisper transcribes both |
| Source attribution labeling | FAIL | Labels everything [User] or distributes inaccurately |
| Device auto-detection | FAIL | Picks wrong device (first in list, not active) |
| Explicit device selection | UNTESTED | User hasn't confirmed in-app with Sound Blaster selected in Settings |
| Graceful fallback (code review) | PASS | 9 layers of protection verified |
| Temp file cleanup (code review) | PASS | deleteOnExit on all temp files |
| On-the-fly toggle | UNTESTED | Manual test not performed |
| Long recording (30+ min) | UNTESTED | Manual test not performed |
| Light/dark theme | UNTESTED | Manual test not performed |

---

## Key Code Locations

- **SystemAudioCapture**: `src/main/java/org/whisperdog/audio/SystemAudioCapture.java`
  - `getDefaultOutputDeviceName()`: Line 117 — BROKEN auto-detect
  - `initialize(String)`: Line 144 — device matching with `.contains()`
  - `onBuffer()`: Line 291 — callback with diagnostics
  - `LOOPBACK_GAIN`: Line 25 — 8.0f amplification

- **AudioCaptureManager**: `src/main/java/org/whisperdog/audio/AudioCaptureManager.java`
  - `startCapture()`: Line 70 — initialization + start order
  - `stopCapture()`: Line 136 — diagnostics + save
  - `toggleSystemAudio()`: Line 177 — mid-recording toggle

- **SourceActivityTracker**: `src/main/java/org/whisperdog/audio/SourceActivityTracker.java`
  - `trackActivity()`: Line 91 — RMS analysis on both tracks
  - `labelTranscript()`: Line 278 — proportional word distribution (new)
  - `labelTranscriptWithTimestamps()`: Line 335 — proper timestamp-based labeling (unused)
  - `DEFAULT_ACTIVITY_THRESHOLD`: Line 29 — 0.005

- **RecorderForm integration**: `src/main/java/org/whisperdog/recording/RecorderForm.java`
  - System audio toggle: ~Line 237-265
  - `startRecording()`: ~Line 1333-1349
  - `stopRecording()`: ~Line 1456-1471
  - `AudioTranscriptionWorker`: ~Line 1818-1883

- **FFmpegUtil.mergeAudioTracks()**: `src/main/java/org/whisperdog/audio/FFmpegUtil.java:315`

- **Settings**: `src/main/java/org/whisperdog/settings/SettingsForm.java:630-663`
