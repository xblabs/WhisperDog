# Checkpoint: CP_2026_01_23_002

**Type**: save_point
**Created**: 2026-01-23T06:30:00Z
**Task**: 0006 - System Audio Capture
**Priority**: high
**AutoLoad**: true

---

## Progress Summary

### Completed
- **Cluster 1**: Platform Research & Feasibility (6/6)
- **Cluster 2**: Dual-Track Capture Infrastructure (7/7)
- **Cluster 3**: Source Attribution Logic (7/7) ✅ FULLY COMPLETE

### Current Position
- **Cluster 4, Item 1**: Add system audio toggle to recording panel - NEXT

### Key Fixes This Session
1. **LOOPBACK_GAIN**: Increased from 4.0f → 8.0f (raw loopback peak was 0.081, too quiet)
2. **Device selection NPE**: `getDefaultOutputDeviceName()` used `platform` before initialization. Fixed by initializing platform in no-arg `initialize()` before querying.
3. **Platform double-init guard**: `initialize(String)` now checks `if (platform == null)` before re-creating
4. **RMS threshold**: Lowered from 0.02 → 0.005 (user mic peaked at 0.015, below old threshold)
5. **Device diagnostics**: Added `loopbackDeviceName` field + getter, `getDiagnostics()` now includes device name

### Test Results (Final Run)
```
Mic peak RMS: 0.027314 (threshold: 0.0050)
Mic intervals above threshold: 26/100
Sys peak RMS: 0.182613 (threshold: 0.0050)
Sys intervals above threshold: 49/101

Verdict: ALL TESTS PASSED
  User detection:    PASS
  System detection:  PASS
  Both detection:    PASS
  Silence detection: PASS
```

### New Task Created
- **Task 0007**: Whisper Vocabulary Hints — send `prompt` parameter to Whisper API for proper noun priming (e.g., "Claude" not "Cloud")

### Files Modified This Session
- `src/main/java/org/whisperdog/audio/SystemAudioCapture.java`:
  - LOOPBACK_GAIN: 4.0f → 8.0f
  - `initialize()`: init platform before `getDefaultOutputDeviceName()`
  - `initialize(String)`: guard against double platform init
  - Added `loopbackDeviceName` field, set in device selection paths
  - `getDiagnostics()` includes device name
- `src/main/java/org/whisperdog/audio/SourceActivityTracker.java`:
  - DEFAULT_ACTIVITY_THRESHOLD: 0.02 → 0.005
- `src/main/java/org/whisperdog/audio/SourceActivityTrackerTest.java`:
  - Added `printRmsDiagnostics()` method
  - Added `getDiagnostics()` output after capture
- `.scaffoldx/xtasks/0006_system_audio_capture/03_checklist.md`:
  - Cluster 3 Item 7 checked

### Next Steps (Priority Order)
1. **Cluster 4: UI Integration**: Add system audio toggle to recording panel, settings dropdown
2. **Cluster 5: Pipeline Integration**: Decide merge strategy, wire AudioCaptureManager into RecorderForm
3. **Cluster 6: Testing & Verification**: End-to-end scenarios

### Available Loopback Devices (User's System)
- [0] Headset Earphone (Plantronics Blackwire 3210 Series) (Loopback)
- [1] Realtek Digital Output (Realtek High Definition Audio) (Loopback)
- [2] Speakers (Sound Blaster Play! 3) (Loopback)

### Test Command
```powershell
powershell -ExecutionPolicy Bypass -File .\run-test.ps1 org.whisperdog.audio.SourceActivityTrackerTest
```
